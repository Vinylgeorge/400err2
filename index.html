<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>📊 MTurk Earnings + Monthly Transfers + Alerts (Secure)</title>
<style>
  :root{--pri:#2563eb;--pri2:#1d4ed8;--bg:#f8fafc}
  *{box-sizing:border-box} body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
  header{background:linear-gradient(135deg,#2563eb,#1e3a8a);color:#fff;padding:20px;border-radius:12px;text-align:center}
  main{margin-top:18px}
  .controls{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
  input[type="text"]{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;width:260px;font-size:14px}
  button{background:var(--pri);border:0;color:#fff;padding:9px 14px;border-radius:8px;cursor:pointer}
  button:hover{background:var(--pri2)}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 16px rgba(0,0,0,.06)}
  th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
  th{background:#f1f5f9}
  tr:hover{background:#f9fafb}
  tr.alert-row{background:#fee2e2!important;color:#b91c1c;font-weight:600}
  footer{margin-top:14px;text-align:center;color:#6b7280;font-size:12px}
  /* Password overlay */
  #gate{position:fixed;inset:0;background:linear-gradient(180deg,#0f172a 0,#111827 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
  #gate .card{width:min(420px,92vw);background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:22px;color:#dbeafe;box-shadow:0 10px 40px rgba(0,0,0,.45)}
  #gate h2{margin:0 0 14px 0;font-weight:700;letter-spacing:.2px}
  #gate p{margin:0 0 12px 0;color:#93c5fd}
  #gate input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0a1222;color:#e5e7eb;outline:none}
  #gate input:focus{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.25)}
  #gate button{width:100%;margin-top:12px;background:#22c55e}
  #gate button:hover{background:#16a34a}
  #gate .msg{margin-top:10px;font-size:12px;color:#fca5a5;min-height:16px}
  #app{display:none}
</style>
</head>
<body>

<!-- 🔐 Password Gate -->
<section id="gate" aria-label="Password Gate">
  <div class="card">
    <h2>🔒 Secure Access</h2>
    <p>Enter password</p>
    <input id="pw" type="password" inputmode="text" autocomplete="current-password" placeholder="•••••••••••••••" />
    <button id="unlockBtn">Unlock</button>
    <div class="msg" id="gateMsg"></div>
  </div>
</section>

<!-- 📊 App -->
<section id="app" aria-label="Dashboard App">
  <header>
    <h1>📊 MTurk Earnings + Alerts + Monthly Transfers</h1>
    <p>Auto-synced from Firebase — grouped by transfer month</p>
  </header>

  <main>
    <div class="controls">
      <input id="searchInput" type="text" placeholder="🔍 Filter by worker, bank, or alert..." />
      <div>
        <button id="refreshBtn">🔄 Refresh</button>
        <button id="exportBtn">📤 Export CSV</button>
      </div>
    </div>

    <table aria-label="Earnings Table">
      <thead>
        <tr>
          <th>Worker ID</th>
          <th>Current Earnings</th>
          <th>Last Transfer ($)</th>
          <th>Last Transfer Date</th>
          <th>Last Month Transfer ($)</th>
          <th>Next Transfer Date</th>
          <th>Bank</th>
          <th>IP</th>
          <th>Alert</th>
          <th>Updated</th>
        </tr>
      </thead>
      <tbody id="dataBody">
        <tr><td colspan="10">Loading… (waiting unlock)</td></tr>
      </tbody>
    </table>
  </main>

  <footer>© 2025 AB2Soft | Monthly Summaries • Alert Monitor • CSV Export</footer>
</section>

<script type="module">
/* -------------------- PASSWORD GATE (SHA-256) -------------------- */
/* Expected SHA-256 of "AB2EARNINGS2025" (lowercase hex) */
const EXPECTED_SHA256 = "9b724d9df97a91d297dc1c714a3987338ebb60a2a53311d2e382411a78b9e07d";

/* hash -> hex */
function toHex(buffer){
  const b = new Uint8Array(buffer);
  let s = "";
  for (let i=0;i<b.length;i++){ s += b[i].toString(16).padStart(2,"0"); }
  return s;
}

/* SHA-256 using SubtleCrypto */
async function sha256(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
  return toHex(buf);
}

/* UI refs */
const gate = document.getElementById("gate");
const app = document.getElementById("app");
const pwInput = document.getElementById("pw");
const unlockBtn = document.getElementById("unlockBtn");
const gateMsg = document.getElementById("gateMsg");

/* Unlock handler */
unlockBtn.addEventListener("click", async () => {
  gateMsg.textContent = "";
  const entered = (pwInput.value || "").trim();
  if(!entered){ gateMsg.textContent = "Password required"; return; }
  try {
    const h = await sha256(entered);
    if (h === EXPECTED_SHA256){
      // Success: reveal app & boot Firebase UI
      gate.style.display = "none";
      app.style.display = "block";
      bootApp();  // start the Firebase viewer after unlock
    } else {
      gateMsg.textContent = "Password incorrect";
    }
  } catch(err){
    gateMsg.textContent = "Crypto error: " + (err?.message || err);
  }
});

pwInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") unlockBtn.click(); });

/* -------------------- DASHBOARD APP (loaded after unlock) -------------------- */
let tableData = [];

async function bootApp(){
  // dynamic imports so Firebase loads only after a successful unlock
  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");
  const { getFirestore, collection, getDocs, orderBy, query } =
    await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");

  // 🔧 Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
    authDomain: "mturk-monitordeep.firebaseapp.com",
    projectId: "mturk-monitordeep",
    storageBucket: "mturk-monitordeep.firebasestorage.app",
    messagingSenderId: "58392297487",
    appId: "1:58392297487:web:1365ad12110ffd0586637a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* Helpers */
  function getMonthKey(dateStr){
    if(!dateStr) return null;
    const parts = String(dateStr).split("/");
    if (parts.length !== 3) return null;
    const [mm, dd, yy] = parts;
    return `${yy}-${mm}`; // e.g. 25-09
  }
  function tsToLocal(ts){
    // Firestore Timestamp or ISO
    if (!ts) return "";
    try{
      if (typeof ts === "object" && typeof ts.seconds === "number"){
        return new Date(ts.seconds*1000).toLocaleString();
      }
      const d = new Date(ts);
      if (!isNaN(d.getTime())) return d.toLocaleString();
    }catch{}
    return String(ts);
  }

  async function loadData(){
    const tbody = document.getElementById("dataBody");
    tbody.innerHTML = "<tr><td colspan='10'>Loading…</td></tr>";
    tableData = [];
    try{
      const qRef = query(collection(db,"earnings_logs"), orderBy("timestamp","desc"));
      const snap = await getDocs(qRef);

      // Build monthly totals (by lastTransferDate month)
      const monthlyTotals = {};
      snap.forEach(doc=>{
        const d = doc.data();
        const key = getMonthKey(d.lastTransferDate);
        if (key){
          const amt = parseFloat(d.lastTransferAmount || 0);
          monthlyTotals[key] = (monthlyTotals[key] || 0) + (isNaN(amt) ? 0 : amt);
        }
      });

      let html = "";
      snap.forEach(doc=>{
        const d = doc.data();
        const key = getMonthKey(d.lastTransferDate);
        const monthSum = key && monthlyTotals[key] ? monthlyTotals[key].toFixed(2) : "0.00";
        const isAlert = d.alert && d.alert !== "OK" && d.alert !== "✅ OK";

        const row = {
          WorkerID: d.workerId || "",
          CurrentEarnings: d.currentEarnings ?? "",
          LastTransfer: d.lastTransferAmount ?? "",
          LastTransferDate: d.lastTransferDate ?? "",
          LastMonthTotal: monthSum,
          NextTransferDate: d.nextTransferDate ?? "",
          BankAccount: d.bankAccount ?? "",
          IP: d.ip ?? "",
          Alert: d.alert || "OK",
          Updated: tsToLocal(d.timestamp)
        };
        tableData.push(row);

        html += `
          <tr class="${isAlert ? "alert-row": ""}">
            <td>${row.WorkerID}</td>
            <td>${row.CurrentEarnings}</td>
            <td>${row.LastTransfer}</td>
            <td>${row.LastTransferDate}</td>
            <td>${row.LastMonthTotal}</td>
            <td>${row.NextTransferDate}</td>
            <td>${row.BankAccount}</td>
            <td>${row.IP}</td>
            <td>${row.Alert}</td>
            <td>${row.Updated}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html || "<tr><td colspan='10'>No records found</td></tr>";
    }catch(err){
      console.error("Error loading Firestore:", err);
      document.getElementById("dataBody").innerHTML =
        "<tr><td colspan='10'>Error loading data.</td></tr>";
    }
  }

  function filterTable(){
    const q = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#dataBody tr");
    rows.forEach(r=>{
      const t = r.textContent.toLowerCase();
      r.style.display = t.includes(q) ? "" : "none";
    });
  }

  function exportCSV(){
    if (!tableData.length){ alert("No data to export."); return; }
    const headers = Object.keys(tableData[0]);
    const csv = [
      headers.join(","),
      ...tableData.map(row => headers.map(h => `"${String(row[h]??"").replace(/"/g,'""')}"`).join(","))
    ].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `MTurk_Earnings_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // Wire up UI now that app is unlocked
  document.getElementById("refreshBtn").addEventListener("click", loadData);
  document.getElementById("searchInput").addEventListener("input", filterTable);
  document.getElementById("exportBtn").addEventListener("click", exportCSV);

  // Initial load
  loadData();
}
</script>

</body>
</html>
