<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üîí MTurk Earnings ‚Äî Secure Dashboard</title>
<style>
  body {
    font-family: Inter, Roboto, Arial, sans-serif;
    background: #f4f6f8;
    color: #111;
    text-align: center;
    padding: 40px;
  }
  .hidden { display: none; }
  #passwordBox {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    display: inline-block;
    margin-bottom: 40px;
  }
  input[type="password"] {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    width: 220px;
    text-align: center;
  }
  button {
    background: #111827;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
  }
  #protected {
    max-width: 1100px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    padding: 20px 30px;
    text-align: left;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th {
    background: #111827;
    color: #fff;
  }
  #loadStatus {
    margin-top: 10px;
    font-style: italic;
    text-align: center;
  }
</style>
</head>
<body>
  <!-- üîí Password Gate -->
  <div id="passwordBox">
    <h2>üîí Secure Access</h2>
    <p>Enter password to view earnings dashboard</p>
    <input type="password" id="passInput" placeholder="Enter password" /><br><br>
    <button id="unlockBtn">Unlock</button>
    <p id="status"></p>
  </div>

  <!-- üìä Dashboard -->
  <div id="protected" class="hidden">
    <h2 style="text-align:center;">üìä MTurk Earnings Dashboard</h2>
    <table>
      <thead>
        <tr>
          <th>Worker ID</th>
          <th>User</th>
          <th>IP</th>
          <th>Current Earnings</th>
          <th>Bank</th>
          <th>Next Transfer</th>
          <th>Last Month Transfer</th>
          <th>Alert</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="earnBody"></tbody>
    </table>
    <div style="text-align:center;">
      <button id="csvExport">‚¨áÔ∏è Export to CSV</button>
      <p id="loadStatus">Loading data...</p>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // üîß Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
    authDomain: "mturk-monitordeep.firebaseapp.com",
    projectId: "mturk-monitordeep",
    storageBucket: "mturk-monitordeep.firebasestorage.app",
    messagingSenderId: "58392297487",
    appId: "1:58392297487:web:1365ad12110ffd0586637a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // üîê Password (encrypted)
  const encPass = "QUIyRUFSTklOR1MyMDI1"; // AB2EARNINGS2025
  const decodePass = atob(encPass);

  const passBox = document.getElementById("passwordBox");
  const protectedDiv = document.getElementById("protected");
  const passInput = document.getElementById("passInput");
  const statusEl = document.getElementById("status");

  document.getElementById("unlockBtn").onclick = () => {
    if (passInput.value === decodePass) {
      passBox.classList.add("hidden");
      protectedDiv.classList.remove("hidden");
      loadData();
      setInterval(loadData, 60000); // üîÅ Auto-refresh every 60 seconds
    } else {
      statusEl.textContent = "‚ùå Wrong password";
      statusEl.style.color = "red";
    }
  };

  async function loadData() {
    const loadStatus = document.getElementById("loadStatus");
    const tbody = document.getElementById("earnBody");
    tbody.innerHTML = "";
    loadStatus.textContent = "‚è≥ Loading data...";
    try {
      const snapshot = await getDocs(collection(db, "earnings_logs"));
      if (snapshot.empty) {
        loadStatus.textContent = "‚ö†Ô∏è No data found in Firestore.";
        return;
      }
      snapshot.forEach(doc => {
        const d = doc.data();
        const ts = d.timestamp?.toDate
          ? d.timestamp.toDate().toLocaleString()
          : (d.timestamp || "");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.workerId || ""}</td>
          <td>${d.user || ""}</td>
          <td>${d.ip || ""}</td>
          <td>${d.currentEarnings || ""}</td>
          <td>${d.bankAccount || ""}</td>
          <td>${d.nextTransferDate || ""}</td>
          <td>${d.lastMonthTransfer || ""}</td>
          <td style="color:${d.alert ? 'red':'green'}">${d.alert || "‚úÖ OK"}</td>
          <td>${ts}</td>`;
        tbody.appendChild(tr);
      });
      loadStatus.textContent = "‚úÖ Data loaded successfully (auto-refresh every 1 min).";
      loadStatus.style.color = "green";
    } catch (err) {
      loadStatus.textContent = "‚ùå Firestore fetch error: " + err.message;
      loadStatus.style.color = "red";
    }
  }

  document.getElementById("csvExport").onclick = () => {
    const rows = [...document.querySelectorAll("table tr")]
      .map(r => [...r.children].map(c => `"${c.innerText}"`).join(","))
      .join("\n");
    const blob = new Blob([rows], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "earnings_logs.csv";
    a.click();
  };
</script>
</body>
</html>
