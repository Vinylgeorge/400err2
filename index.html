<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üìä AB2soft Summary Dashboard</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f8fafc;
    color: #111827;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #0f62fe;
    margin-bottom: 20px;
  }
  .card {
    background: white;
    padding: 16px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  .total-box {
    font-size: 22px;
    font-weight: bold;
    color: #0f62fe;
    text-align: center;
    margin-bottom: 20px;
  }
  .team-list {
    margin-top: 10px;
  }
  .team-item {
    background: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: 0.2s;
  }
  .team-item:hover {
    background: #e0f2fe;
    border-color: #0ea5e9;
  }
  .team-name {
    font-size: 18px;
    color: #0f62fe;
  }
  .team-earn {
    font-size: 16px;
    color: #065f46;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>üìä AB2soft Admin Summary</h1>

<div class="card">
  <div id="totalEarnings" class="total-box">Your Total Earnings: $0.00</div>
</div>

<div class="card">
  <h2>üßë‚Äçü§ù‚Äçüßë Team Earnings</h2>
  <div id="teamList" class="team-list">Loading‚Ä¶</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBZKAO1xSMUWBWHusx8sfZGs0yd3QIKOqU",
  authDomain: "hasibteam1-10981.firebaseapp.com",
  projectId: "hasibteam1-10981",
  storageBucket: "hasibteam1-10981.firebasestorage.app",
  messagingSenderId: "537251545985",
  appId: "1:537251545985:web:05b1667f9ec7eb6258de80"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let earningsByTeam = {};
let VALID_TEAMS = new Set(); // Teams from spreadsheet

// Load valid team list from Google Sheet
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/1Jmx4qVw9J_CQNZPuq_hCL08lZzSW2vO4rEl9z9uO5sU/export?format=csv&gid=0";

// Load valid teams (SERVER IP, TEAM, USERNAME, WORKER ID, etc.)
async function loadValidTeams() {
  const resp = await fetch(SHEET_CSV);
  const text = await resp.text();
  const rows = text.split("\n").map(r => r.split(","));
  const headers = rows.shift();
  const teamIndex = headers.findIndex(h => h.trim().toLowerCase() === "team");

  rows.forEach(row => {
    const t = (row[teamIndex] || "").trim();
    if (t && t.toLowerCase() !== "unknown" && t.toLowerCase() !== "undefined" && t !== "N/A") {
      VALID_TEAMS.add(t);
    }
  });
}

// After loading valid teams ‚Üí load Firestore
await loadValidTeams();

onSnapshot(collection(db, "earnings_logs"), (snap) => {
  earningsByTeam = {};

  snap.forEach(docSnap => {
    const d = docSnap.data();
    const team = (d["TEAM"] || "").trim();

    // ‚ùå Skip unknown or invalid teams
    if (!team || !VALID_TEAMS.has(team)) return;

    const cur = parseFloat(d.currentEarnings || 0);

    if (!earningsByTeam[team]) earningsByTeam[team] = 0;
    earningsByTeam[team] += cur;
  });

  updateUI();
});

// Update summary UI
function updateUI() {
  const totalElem = document.getElementById("totalEarnings");
  const teamList = document.getElementById("teamList");

  let totalAllTeams = 0;
  teamList.innerHTML = "";

  Object.keys(earningsByTeam).forEach(team => {
    const teamEarn = earningsByTeam[team];
    totalAllTeams += teamEarn;

    const div = document.createElement("div");
    div.className = "team-item";
    div.innerHTML = `
      <div class="team-name">${team}</div>
      <div class="team-earn">$${teamEarn.toFixed(2)}</div>
    `;

    // Clicking opens full detailed page with filter
    div.onclick = () => {
      window.location.href = `./details.html?team=${encodeURIComponent(team)}`;
    };

    teamList.appendChild(div);
  });

  totalElem.textContent = `Your Total Earnings: $${totalAllTeams.toFixed(2)}`;
}
</script>

</body>
</html>
