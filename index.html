<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“Š AB2soft Summary Dashboard</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f8fafc;
    color: #111827;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #0f62fe;
    margin-bottom: 20px;
  }
  section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 16px;
    margin-bottom: 24px;
  }
  .team-link {
    color: #0f62fe;
    cursor: pointer;
    font-weight: bold;
    text-decoration: underline;
  }
  .team-link:hover {
    color: #2563eb;
  }
  #summaryTable th, #summaryTable td {
    padding: 8px 10px;
    border-bottom: 1px solid #e5e7eb;
  }
  #summaryTable th {
    background: #0f62fe;
    color: white;
  }
  .hidden { display: none; }
  #detailsSection table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  #detailsSection th, #detailsSection td {
    padding: 6px 8px;
    border-bottom: 1px solid #e5e7eb;
  }
  #detailsSection th {
    background: #0f62fe;
    color: white;
  }
</style>
</head>
<body>

<h1>ðŸ“Š AB2soft Earnings Summary</h1>

<!-- ðŸ”¹ SUMMARY SECTION -->
<section id="summarySection">
  <h2>ðŸ’° Summary</h2>
  <div id="totalEarnings" style="font-size:18px;font-weight:bold;color:#15803d;">
    Total Earnings (All Teams): $0.00
  </div>
  <table id="summaryTable">
    <thead>
      <tr>
        <th>Team</th>
        <th>Total Earnings ($)</th>
        <th>Members</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- ðŸ”¹ DETAILED TEAM SECTION -->
<section id="detailsSection" class="hidden">
  <h2 id="teamHeader">Team Details</h2>
  <button onclick="hideDetails()" style="margin-bottom:10px;">â¬… Back to Summary</button>
  <table id="teamTable">
    <thead>
      <tr>
        <th>SERVER IP</th>
        <th>USERNAME</th>
        <th>WORKER ID</th>
        <th>Current Earnings</th>
        <th>Last Month</th>
        <th>Last Transfer ($)</th>
        <th>Last Transfer Date</th>
        <th>Next Transfer Date</th>
        <th>Transfer Method</th>
        <th>IP</th>
        <th>Alert</th>
        <th>Timestamp (BD)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// âœ… Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBZKAO1xSMUWBWHusx8sfZGs0yd3QIKOqU",
  authDomain: "hasibteam1-10981.firebaseapp.com",
  projectId: "hasibteam1-10981",
  storageBucket: "hasibteam1-10981.firebasestorage.app",
  messagingSenderId: "537251545985",
  appId: "1:537251545985:web:05b1667f9ec7eb6258de80"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Time formatter (Bangladesh)
function formatBDTime(t) {
  try {
    const d = new Date(t.seconds ? t.seconds * 1000 : new Date(t).getTime());
    return d.toLocaleString("en-BD", { timeZone: "Asia/Dhaka", hour12: true });
  } catch { return "â€”"; }
}

let allData = [];

onSnapshot(collection(db, "earnings_logs"), (snap) => {
  allData = [];
  snap.forEach(docSnap => {
    allData.push(docSnap.data());
  });
  renderSummary();
});

function renderSummary() {
  const tbody = document.querySelector("#summaryTable tbody");
  const totalElem = document.querySelector("#totalEarnings");
  tbody.innerHTML = "";

  const teamTotals = {};
  let grandTotal = 0;

  for (const d of allData) {
    const team = d["TEAM"] || "Unknown";
    const earnings = parseFloat(d.currentEarnings || 0);
    grandTotal += earnings;
    if (!teamTotals[team]) teamTotals[team] = { total: 0, members: 0 };
    teamTotals[team].total += earnings;
    teamTotals[team].members++;
  }

  totalElem.textContent = `Total Earnings (All Teams): $${grandTotal.toFixed(2)}`;

  Object.entries(teamTotals).forEach(([team, data]) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><span class="team-link" onclick="showDetails('${team}')">${team}</span></td>
      <td>$${data.total.toFixed(2)}</td>
      <td>${data.members}</td>
    `;
    tbody.appendChild(row);
  });
}

window.showDetails = (team) => {
  const detailSection = document.querySelector("#detailsSection");
  const summarySection = document.querySelector("#summarySection");
  const teamHeader = document.querySelector("#teamHeader");
  const tbody = document.querySelector("#teamTable tbody");
  teamHeader.textContent = `Team: ${team}`;
  summarySection.classList.add("hidden");
  detailSection.classList.remove("hidden");
  tbody.innerHTML = "";

  const teamData = allData.filter(d => (d["TEAM"] || "") === team);
  for (const d of teamData) {
    const alertHTML = d.alert?.trim()
      ? `<span style="color:#dc2626;font-weight:600;">${d.alert}</span>`
      : `<span style="color:#16a34a;">âœ” OK</span>`;
    tbody.innerHTML += `
      <tr>
        <td>${d["SERVER IP"] || ""}</td>
        <td>${d["USERNAME"] || ""}</td>
        <td>${d["WORKER ID"] || ""}</td>
        <td>${d.currentEarnings || ""}</td>
        <td>${d.lastMonthEarnings || ""}</td>
        <td>${d.lastTransferAmount || ""}</td>
        <td>${d.lastTransferDate || ""}</td>
        <td>${d.nextTransferDate || ""}</td>
        <td>${d.bankAccount || ""}</td>
        <td>${d.ip || ""}</td>
        <td>${alertHTML}</td>
        <td>${formatBDTime(d.timestamp)}</td>
      </tr>
    `;
  }
};

window.hideDetails = () => {
  document.querySelector("#detailsSection").classList.add("hidden");
  document.querySelector("#summarySection").classList.remove("hidden");
};
</script>
</body>
</html>
