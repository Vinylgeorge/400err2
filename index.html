<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üîí Secure MTurk Earnings Dashboard</title>
<style>
  body { font-family: "Inter", Roboto, Arial, sans-serif; background:#f9fafb; margin:0; color:#111; }
  #auth-section,#dashboard{max-width:1200px;margin:60px auto;background:white;border-radius:10px;padding:30px;box-shadow:0 2px 12px rgba(0,0,0,0.08);}
  h1{text-align:center;color:#1e3a8a;margin-bottom:10px;}
  #password{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:16px;margin-top:10px;}
  button{background:#2563eb;color:white;border:none;border-radius:6px;padding:10px 18px;cursor:pointer;margin-top:15px;font-size:15px;}
  button:hover{background:#1d4ed8;}
  table{width:100%;border-collapse:collapse;margin-top:20px;background:white;}
  th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:14px;}
  th{background:#f1f5f9;}
  .alert-row{background:#fee2e2;color:#b91c1c;font-weight:600;}
  .controls{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
  input[type="text"]{padding:8px;border-radius:6px;border:1px solid #ccc;width:260px;}
  footer{text-align:center;color:#666;margin-top:20px;font-size:13px;}
</style>
</head>
<body>

<div id="auth-section">
  <h1>üîí Secure Access</h1>
  <p>Enter password to view MTurk Earnings Dashboard</p>
  <input type="password" id="password" placeholder="Enter password">
  <button id="unlockBtn">Unlock</button>
  <p id="auth-msg" style="color:red;margin-top:10px;"></p>
</div>

<div id="dashboard" style="display:none;">
  <h1>üìä MTurk Earnings + Alerts + Monthly Transfers</h1>
  <div class="controls">
    <input type="text" id="searchInput" placeholder="üîç Filter by worker, bank, or alert...">
    <div><button id="exportBtn">üì§ Export CSV</button></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Worker ID</th><th>Current Earnings</th><th>Last Transfer ($)</th>
        <th>Last Transfer Date</th><th>Last Month Total ($)</th>
        <th>Next Transfer Date</th><th>Bank</th><th>IP</th>
        <th>Alert</th><th>Updated</th>
      </tr>
    </thead>
    <tbody id="dataBody">
      <tr><td colspan="10">Waiting for data...</td></tr>
    </tbody>
  </table>
  <footer>¬© 2025 AB2Soft | Real-time Firebase Sync + CSV Export</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// üîê Inline MD5 implementation (no browser restriction)
function md5cycle(x, k) {
  let [a,b,c,d]=x;
  a=ff(a,b,c,d,k[0],7,-680876936); d=ff(d,a,b,c,k[1],12,-389564586);
  c=ff(c,d,a,b,k[2],17,606105819); b=ff(b,c,d,a,k[3],22,-1044525330);
  a=ff(a,b,c,d,k[4],7,-176418897); d=ff(d,a,b,c,k[5],12,1200080426);
  c=ff(c,d,a,b,k[6],17,-1473231341); b=ff(b,c,d,a,k[7],22,-45705983);
  a=ff(a,b,c,d,k[8],7,1770035416); d=ff(d,a,b,c,k[9],12,-1958414417);
  c=ff(c,d,a,b,k[10],17,-42063); b=ff(b,c,d,a,k[11],22,-1990404162);
  a=ff(a,b,c,d,k[12],7,1804603682); d=ff(d,a,b,c,k[13],12,-40341101);
  c=ff(c,d,a,b,k[14],17,-1502002290); b=ff(b,c,d,a,k[15],22,1236535329);
  a=gg(a,b,c,d,k[1],5,-165796510); d=gg(d,a,b,c,k[6],9,-1069501632);
  c=gg(c,d,a,b,k[11],14,643717713); b=gg(b,c,d,a,k[0],20,-373897302);
  a=gg(a,b,c,d,k[5],5,-701558691); d=gg(d,a,b,c,k[10],9,38016083);
  c=gg(c,d,a,b,k[15],14,-660478335); b=gg(b,c,d,a,k[4],20,-405537848);
  a=gg(a,b,c,d,k[9],5,568446438); d=gg(d,a,b,c,k[14],9,-1019803690);
  c=gg(c,d,a,b,k[3],14,-187363961); b=gg(b,c,d,a,k[8],20,1163531501);
  a=gg(a,b,c,d,k[13],5,-1444681467); d=gg(d,a,b,c,k[2],9,-51403784);
  c=gg(c,d,a,b,k[7],14,1735328473); b=gg(b,c,d,a,k[12],20,-1926607734);
  a=hh(a,b,c,d,k[5],4,-378558); d=hh(d,a,b,c,k[8],11,-2022574463);
  c=hh(c,d,a,b,k[11],16,1839030562); b=hh(b,c,d,a,k[14],23,-35309556);
  a=hh(a,b,c,d,k[1],4,-1530992060); d=hh(d,a,b,c,k[4],11,1272893353);
  c=hh(c,d,a,b,k[7],16,-155497632); b=hh(b,c,d,a,k[10],23,-1094730640);
  a=hh(a,b,c,d,k[13],4,681279174); d=hh(d,a,b,c,k[0],11,-358537222);
  c=hh(c,d,a,b,k[3],16,-722521979); b=hh(b,c,d,a,k[6],23,76029189);
  a=hh(a,b,c,d,k[9],4,-640364487); d=hh(d,a,b,c,k[12],11,-421815835);
  c=hh(c,d,a,b,k[15],16,530742520); b=hh(b,c,d,a,k[2],23,-995338651);
  a=ii(a,b,c,d,k[0],6,-198630844); d=ii(d,a,b,c,k[7],10,1126891415);
  c=ii(c,d,a,b,k[14],15,-1416354905); b=ii(b,c,d,a,k[5],21,-57434055);
  a=ii(a,b,c,d,k[12],6,1700485571); d=ii(d,a,b,c,k[3],10,-1894986606);
  c=ii(c,d,a,b,k[10],15,-1051523); b=ii(b,c,d,a,k[1],21,-2054922799);
  a=ii(a,b,c,d,k[8],6,1873313359); d=ii(d,a,b,c,k[15],10,-30611744);
  c=ii(c,d,a,b,k[6],15,-1560198380); b=ii(b,c,d,a,k[13],21,1309151649);
  a=ii(a,b,c,d,k[4],6,-145523070); d=ii(d,a,b,c,k[11],10,-1120210379);
  c=ii(c,d,a,b,k[2],15,718787259); b=ii(b,c,d,a,k[9],21,-343485551);
  x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3]);
}
function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32((a<<s)|(a>>>(32-s)),b);}
function ff(a,b,c,d,x,s,t){return cmn((b&c)|((~b)&d),a,b,x,s,t);}
function gg(a,b,c,d,x,s,t){return cmn((b&d)|(c&(~d)),a,b,x,s,t);}
function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t);}
function ii(a,b,c,d,x,s,t){return cmn(c^(b|(~d)),a,b,x,s,t);}
function md51(s){let txt="";let n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;
for(i=64;i<=s.length;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));
s=s.substring(i-64);let tail=Array(16).fill(0);
for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<((i%4)<<3);
tail[i>>2]|=0x80<<((i%4)<<3);
if(i>55){md5cycle(state,tail);tail=Array(16).fill(0);}
tail[14]=n*8;md5cycle(state,tail);return state;}
function md5blk(s){let md5blks=[];for(let i=0;i<64;i+=4)
md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks;}
function rhex(n){let s="",j=0;for(;j<4;j++)s+=("0"+((n>>(j*8+4))&15).toString(16)).slice(-1)+("0"+((n>>(j*8))&15).toString(16)).slice(-1);return s;}
function hex(x){for(let i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("");}
function md5(s){return hex(md51(s));}
function add32(a,b){return (a+b)&0xFFFFFFFF;}


const ENCRYPTED_PASS="4b6ed10e9622a993b1c9edbb40abce9e";

document.getElementById("unlockBtn").addEventListener("click",()=>{
  const pass=document.getElementById("password").value.trim();
  if(md5(pass)===ENCRYPTED_PASS){
    document.getElementById("auth-section").style.display="none";
    document.getElementById("dashboard").style.display="block";
    initDashboard();
  }else document.getElementById("auth-msg").textContent="‚ùå Incorrect password";
});

// üîß Firebase setup
const firebaseConfig={
  apiKey:"AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
  authDomain:"mturk-monitordeep.firebaseapp.com",
  projectId:"mturk-monitordeep",
  storageBucket:"mturk-monitordeep.firebasestorage.app",
  messagingSenderId:"58392297487",
  appId:"1:58392297487:web:1365ad12110ffd0586637a"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let tableData=[];
function getMonthKey(dateStr){if(!dateStr)return null;const[mm,dd,yy]=dateStr.split("/");return`${yy}-${mm}`;}

function initDashboard(){
  const q=query(collection(db,"earnings_logs"),orderBy("timestamp","desc"));
  const tableBody=document.getElementById("dataBody");
  onSnapshot(q,snapshot=>{
    tableBody.innerHTML="<tr><td colspan='10'>Updating...</td></tr>";tableData=[];
    const monthlyTransfers={};
    snapshot.forEach(doc=>{
      const d=doc.data(),key=getMonthKey(d.lastTransferDate);
      if(key){if(!monthlyTransfers[key])monthlyTransfers[key]=0;
      monthlyTransfers[key]+=parseFloat(d.lastTransferAmount||0);}
    });
    let html="";
    snapshot.forEach(doc=>{
      const d=doc.data(),isAlert=d.alert&&d.alert!=="OK";
      const monthKey=getMonthKey(d.lastTransferDate);
      const lastMonthTotal=monthKey?(monthlyTransfers[monthKey]||0).toFixed(2):"0.00";
      const row={
        WorkerID:d.workerId||"",CurrentEarnings:d.currentEarnings||"",
        LastTransfer:d.lastTransferAmount||"",LastTransferDate:d.lastTransferDate||"",
        LastMonthTotal:lastMonthTotal,NextTransferDate:d.nextTransferDate||"",
        BankAccount:d.bankAccount||"",IP:d.ip||"",Alert:d.alert||"OK",
        Updated:new Date(d.timestamp?.seconds*1000||Date.now()).toLocaleString()
      };
      tableData.push(row);
      html+=`<tr class="${isAlert?"alert-row":""}">
        <td>${row.WorkerID}</td><td>${row.CurrentEarnings}</td>
        <td>${row.LastTransfer}</td><td>${row.LastTransferDate}</td>
        <td>${row.LastMonthTotal}</td><td>${row.NextTransferDate}</td>
        <td>${row.BankAccount}</td><td>${row.IP}</td><td>${row.Alert}</td><td>${row.Updated}</td></tr>`;
    });
    tableBody.innerHTML=html||"<tr><td colspan='10'>No records found</td></tr>";
  });
}

document.addEventListener("keyup",e=>{
  if(e.target.id==="searchInput"){
    const filter=e.target.value.toLowerCase();
    document.querySelectorAll("#dataBody tr").forEach(tr=>{
      tr.style.display=tr.textContent.toLowerCase().includes(filter)?"":"none";
    });
  }
});
document.getElementById("exportBtn").addEventListener("click",()=>{
  if(!tableData.length)return alert("No data to export");
  const headers=Object.keys(tableData[0]);
  const csvRows=[headers.join(",")];
  for(const row of tableData)
    csvRows.push(headers.map(h=>`"${(row[h]||"").toString().replace(/"/g,'""')}"`).join(","));
  const blob=new Blob([csvRows.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");a.href=url;
  a.download=`Earnings_${new Date().toISOString().split("T")[0]}.csv`;a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
