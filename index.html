<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MTurk Earnings Dashboard + Alerts</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
    authDomain: "mturk-monitordeep.firebaseapp.com",
    projectId: "mturk-monitordeep",
    storageBucket: "mturk-monitordeep.firebasestorage.app",
    messagingSenderId: "58392297487",
    appId: "1:58392297487:web:1365ad12110ffd0586637a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function loadData() {
    const tableBody = document.getElementById("dataBody");
    tableBody.innerHTML = "<tr><td colspan='9'>Loading...</td></tr>";
    try {
      const q = query(collection(db, "earnings_logs"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      let html = "";

      snapshot.forEach(doc => {
        const d = doc.data();
        const isAlert = d.alert && d.alert !== "OK";
        html += `
          <tr class="${isAlert ? "alert-row" : ""}">
            <td>${d.workerId || ""}</td>
            <td>${d.currentEarnings || ""}</td>
            <td>${d.lastTransferAmount || ""}</td>
            <td>${d.lastTransferDate || ""}</td>
            <td>${d.nextTransferDate || ""}</td>
            <td>${d.bankAccount || ""}</td>
            <td>${d.ip || ""}</td>
            <td>${d.alert || "OK"}</td>
            <td>${new Date(d.timestamp?.seconds * 1000 || Date.now()).toLocaleString()}</td>
          </tr>
        `;
      });

      tableBody.innerHTML = html || "<tr><td colspan='9'>No data found</td></tr>";
    } catch (e) {
      console.error(e);
      tableBody.innerHTML = "<tr><td colspan='9'>Error fetching data.</td></tr>";
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("refreshBtn").onclick = loadData;
    loadData();
  });
</script>

<style>
  body { font-family: 'Inter', sans-serif; background: #f7fafc; margin: 0; padding: 20px; color: #111; }
  h1 { text-align: center; color: #1d4ed8; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; }
  th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
  th { background: #e5e7eb; }
  tr.alert-row { background: #fee2e2 !important; color: #b91c1c; font-weight: 600; }
  button { background: #2563eb; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; }
  button:hover { background: #1d4ed8; }
</style>
</head>
<body>
  <h1>ðŸ“Š MTurk Earnings + Alerts</h1>
  <div style="text-align:center"><button id="refreshBtn">ðŸ”„ Refresh</button></div>
  <table>
    <thead>
      <tr>
        <th>Worker ID</th>
        <th>Current Earnings</th>
        <th>Last Transfer ($)</th>
        <th>Last Transfer Date</th>
        <th>Next Transfer Date</th>
        <th>Bank</th>
        <th>IP</th>
        <th>ALERT</th>
        <th>Updated</th>
      </tr>
    </thead>
    <tbody id="dataBody"><tr><td colspan="9">Loading...</td></tr></tbody>
  </table>
</body>
</html>
