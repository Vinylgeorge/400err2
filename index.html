<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MTurk Earnings Secure Uploader</title>
<style>
body{font-family:system-ui,sans-serif;background:#f5f7fa;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0;color:#333}
#login,#protected{background:#fff;padding:30px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.1);text-align:center}
#protected{display:none!important}
input{padding:10px 14px;border-radius:8px;border:1px solid #ccc;margin-top:10px;width:240px;text-align:center}
button{margin-top:10px;padding:10px 20px;border:none;border-radius:8px;background:#0078d7;color:#fff;cursor:pointer}
</style>
</head>
<body>
<div id="login">
  <h2>üîí Secure Access</h2>
  <input id="p" type="password" placeholder="Enter password">
  <br><button id="u">Unlock</button>
  <p id="m"></p>
</div>

<div id="protected">
  <h3>üîÅ Running background sync...</h3>
  <p>This page uploads data automatically when updates are detected.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

(function(){
"use strict";
const _0xpw = atob("QUIyRUFSTklOR1MyMDI1"); // password AB2EARNINGS2025
document.getElementById("u").addEventListener("click",unlock);
document.getElementById("p").addEventListener("keypress",e=>{if(e.key==="Enter")unlock();});

function unlock(){
  const v=document.getElementById("p").value.trim();
  if(v===_0xpw){
    document.getElementById("login").style.display="none";
    document.getElementById("protected").style.display="block";
    startUploader();
  }else{
    document.getElementById("m").textContent="‚ùå Wrong password!";
  }
}

async function startUploader(){
  const firebaseConfig={
    apiKey:"AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
    authDomain:"mturk-monitordeep.firebaseapp.com",
    projectId:"mturk-monitordeep",
    storageBucket:"mturk-monitordeep.firebasestorage.app",
    messagingSenderId:"58392297487",
    appId:"1:58392297487:web:1365ad12110ffd0586637a"
  };
  const app=initializeApp(firebaseConfig);
  const db=getFirestore(app);

  const sheetUrl="https://docs.google.com/spreadsheets/d/1Ytmr7dHSAv69N27uZcrhKaEerL8WhzMCI02vugq_C_M/export?format=csv&gid=0";

  // Helper to parse CSV ‚Üí map
  async function loadUserMap(){
    const res=await fetch(sheetUrl);
    const text=await res.text();
    const rows=text.trim().split("\n").map(r=>r.split(","));
    const header=rows.shift();
    const idxID=header.indexOf("workerId");
    const idxUser=header.indexOf("user");
    const map={};
    rows.forEach(r=>{
      if(r[idxID]) map[r[idxID].trim()]=r[idxUser]?r[idxUser].trim():"";
    });
    return map;
  }

  // Extract WorkerID
  function extractWorkerID(){
    try{
      const els=document.querySelectorAll('[data-react-props*="textToCopy"]');
      for(const e of els){
        const d=e.getAttribute("data-react-props").replace(/&quot;/g,'"');
        const p=JSON.parse(d);
        if(p.textToCopy && /^A[0-9A-Z]+$/.test(p.textToCopy)) return p.textToCopy;
      }
      const txt=document.body.innerText.match(/\bA[0-9A-Z]{10,}\b/);
      return txt?txt[0]:"N/A";
    }catch{return"N/A";}
  }

  // Extract earnings info
  function getEarningsData(){
    const html=document.documentElement.innerHTML;
    const mE=html.match(/Current Earnings:\s*\$([\d.]+)/);
    const mB=html.match(/bank account\s*<a[^>]*>([^<]+)/i);
    const mN=html.match(/on\s+([A-Z][a-z]{2}\s+\d{2},\s+\d{4})\s+based on/i);
    const jsonMatch=html.match(/data-react-props="([^"]+)"/);
    let lastDate="N/A",lastAmt="N/A";
    if(jsonMatch){
      try{
        const js=JSON.parse(jsonMatch[1].replace(/&quot;/g,'"'));
        if(js.bodyData && js.bodyData[0]){
          lastDate=js.bodyData[0].requestedDate||"";
          lastAmt=js.bodyData[0].amountRequested||"";
        }
      }catch{}
    }
    return {
      currentEarnings:mE?("$"+mE[1]):"",
      bankAccount:mB?mB[1].trim():"",
      nextTransferDate:mN?mN[1].trim():"",
      lastTransferDate:lastDate,
      lastTransferAmount:lastAmt
    };
  }

  // Compare and upload only if changed
  async function syncData(){
    const userMap=await loadUserMap();
    const workerId=extractWorkerID();
    if(workerId==="N/A") return;
    const ipResp=await fetch("https://api.ipify.org?format=json").then(r=>r.json()).catch(()=>({ip:"N/A"}));
    const ip=ipResp.ip;
    const earn=getEarningsData();
    const user=userMap[workerId]||"Unknown";
    const docRef=doc(db,"earnings",workerId);
    const prev=(await getDoc(docRef)).data()||{};
    let alert="";
    if(prev.bankAccount && prev.bankAccount!==earn.bankAccount) alert="Bank Changed";
    if(prev.ip && prev.ip!==ip) alert="IP Changed";
    if(alert){await setDoc(docRef,{...prev,alert,timestamp:new Date().toISOString()});return;}
    const changed=JSON.stringify(prev)!==JSON.stringify({...earn,workerId,user,ip});
    if(changed){
      await setDoc(docRef,{...earn,workerId,user,ip,alert:"",timestamp:new Date().toISOString()});
      console.log("‚¨ÜÔ∏è Uploaded update for",workerId);
    }else{
      console.log("‚è∏ No change detected");
    }
  }

  await syncData();
}
})();
</script>
</body>
</html>
