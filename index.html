<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“Š Team Summary</title>

<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f8fafc;
    color: #111827;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #0f62fe;
    margin-bottom: 25px;
    font-size: 28px;
  }
  section {
    background: white;
    padding: 16px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    padding: 10px 12px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 15px;
  }
  th {
    background: #0f62fe;
    color: white;
    text-align: left;
  }
  tr:hover {
    background: #eef2ff;
    cursor: pointer;
  }
  #total {
    font-size: 20px;
    font-weight: bold;
    color: #15803d;
    margin-bottom: 10px;
  }
</style>
</head>

<body>
<h1>ðŸ“Š Team Earnings Summary</h1>

<section>
  <div id="total">Total Earnings: $0</div>

  <table>
    <thead>
      <tr>
        <th>Team</th>
        <th>Workers</th>
        <th>Total Earnings ($)</th>
      </tr>
    </thead>
    <tbody id="teamBody"></tbody>
  </table>
</section>

<script type="module">
import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } 
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBZKAO1xSMUWBWHusx8sfZGs0yd3QIKOqU",
  authDomain: "hasibteam1-10981.firebaseapp.com",
  projectId: "hasibteam1-10981",
  storageBucket: "hasibteam1-10981.firebasestorage.app",
  messagingSenderId: "537251545985",
  appId: "1:537251545985:web:05b1667f9ec7eb6258de80"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- HELPERS ---------- */
function safeValue(newVal, oldVal) {
  if (!newVal || newVal === "" || newVal === "UNKNOWN")
    return oldVal || "â€”";
  return newVal;
}

function parseBDdate(str) {
  if (!str || str === "â€”") return null;
  const [mm, dd, yyyy] = str.split("/").map(v => parseInt(v));
  if (!mm || !dd || !yyyy) return null;
  return new Date(yyyy, mm - 1, dd);
}

function isCurrentMonth(dateObj) {
  if (!dateObj) return false;
  const nowBD = new Date().toLocaleString("en-US", { timeZone: "Asia/Dhaka" });
  const now = new Date(nowBD);
  return (
    dateObj.getMonth() === now.getMonth() &&
    dateObj.getFullYear() === now.getFullYear()
  );
}

/* ---------- SNAPSHOT ---------- */
onSnapshot(collection(db, "earnings_logs"), (snap) => {
  const teamMap = {};
  let totalAll = 0;

  snap.forEach(docSnap => {
    const d = docSnap.data();

    if (!d.TEAM || d.TEAM === "UNKNOWN") return;

    /* Use old data if new one missing */
    const curr = parseFloat(safeValue(d.currentEarnings, d.prev_currentEarnings));
    const lastAmt = parseFloat(safeValue(d.lastTransferAmount, d.prev_lastTransferAmount));
    const lastDateStr = safeValue(d.lastTransferDate, d.prev_lastTransferDate);

    const lastDateObj = parseBDdate(lastDateStr);
    if (isNaN(curr)) return;

    let workerTotal = curr;
    if (lastDateObj && isCurrentMonth(lastDateObj)) {
      if (!isNaN(lastAmt)) workerTotal += lastAmt;
    }

    const team = d.TEAM.trim();
    if (!teamMap[team]) teamMap[team] = { workers: 0, total: 0 };

    teamMap[team].workers++;
    teamMap[team].total += workerTotal;
    totalAll += workerTotal;
  });

  const list = Object.keys(teamMap).map(team => ({
    team,
    workers: teamMap[team].workers,
    total: teamMap[team].total
  }));

  list.sort((a, b) => b.total - a.total);

  const tbody = document.getElementById("teamBody");
  tbody.innerHTML = "";

  list.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.team}</td>
      <td>${item.workers}</td>
      <td>$${item.total.toFixed(2)}</td>
    `;
    tr.onclick = () => {
      window.location.href = `details.html?team=${encodeURIComponent(item.team)}`;
    };
    tbody.appendChild(tr);
  });

  document.getElementById("total").textContent =
    `Total Earnings: $${totalAll.toFixed(2)}`;
});
</script>

</body>
</html>
